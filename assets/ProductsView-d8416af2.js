import{a9 as G,x as n,ak as Q,ab as K,al as W,c as l,ad as o,ap as X,a0 as Y,ai as Z,J as v,ah as S,ag as D,aJ as ee,V as ae,ac as le,am as te,ae as s,af as oe,aq as se,aw as re,ao as ne,ar as ue,as as ie,aK as de,av as me,aL as ce}from"./index-2e906d0c.js";import{c as pe,a as I,d as ve,e as ge,V as Ve}from"./index.esm-de8aadb6.js";import{u as fe,a as g}from"./vee-validate.esm-018bef8b.js";import{V as be}from"./VContainer-451776cb.js";import{V as ye}from"./VRow-ad76bf31.js";import{V as $}from"./VCol-dc2434c8.js";import{V as ke}from"./VDivider-bdd82a0d.js";import{V as Ce}from"./VDataTableServer-947aec2b.js";import{a as we}from"./VDataTable-8815a807.js";import{a as xe,V as Be}from"./VTextarea-89071b05.js";import"./VList-5a36ea62.js";import"./VMenu-d82125ac.js";const Pe=me("h1",{class:"text-center"},"商品管理",-1),Re={__name:"ProductsView",setup(Se){const{apiAuth:V}=Z(),p=G(),T=n(null),f=n(!1),i=n(""),q=r=>{r?(i.value=r._id,b.value.value=r.name,y.value.value=r.price,k.value.value=r.description,C.value.value=r.category,w.value.value=r.sell,console.log(i.value)):i.value="",f.value=!0},L=()=>{f.value=!1,H(),T.value.deleteFileRecord()},z=async r=>{var a,u;try{await V.delete("/products/"+r._id),p({text:"刪除成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),m()}catch(e){console.log(e);const t=((u=(a=e==null?void 0:e.response)==null?void 0:a.data)==null?void 0:u.message)||"發生錯誤，請稍後再試";p({text:t,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},N=["調酒用品","基酒","風味酒","利口酒"],E=pe({name:I().required("缺少商品名稱"),price:ve().typeError("商品價格格式錯誤").required("缺少商品價格").min(0,"商品價格不能小於 0"),description:I().required("缺少商品說明"),category:I().required("缺少商品分類").test("isCategory","商品分類錯誤",r=>N.includes(r)),sell:ge()}),{handleSubmit:J,isSubmitting:U,resetForm:H}=fe({validationSchema:E,initialValues:{name:"",price:0,description:"",category:"",sell:!1}}),b=g("name"),y=g("price"),k=g("description"),C=g("category"),w=g("sell"),d=n([]),R=n([]),O=J(async r=>{var a,u,e;if(!((a=d.value[0])!=null&&a.error)&&!(i.value===""&&d.value.length===0))try{const t=new FormData;for(const c in r)t.append(c,r[c]);d.value.length>0&&t.append("image",d.value[0].file),i.value===""?await V.post("/products",t):await V.patch("/products/"+i.value,t),p({text:i.value===""?"新增成功":"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),L(),M()}catch(t){console.log(t);const c=((e=(u=t==null?void 0:t.response)==null?void 0:u.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";p({text:c,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),h=n(10),x=n([{key:"createdAt",order:"desc"}]),B=n(1),F=n([]),j=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"名稱",align:"center",sortable:!0,key:"name"},{title:"價格",align:"center",sortable:!0,key:"price"},{title:"分類",align:"center",sortable:!0,key:"category"},{title:"上架",align:"center",sortable:!0,key:"sell"},{title:"編輯",align:"center",sortable:!1,key:"edit"},{title:"刪除",align:"center",sortable:!1,key:"delete"}],A=n(!0),_=n(0),P=n(""),m=async()=>{var r,a,u,e;A.value=!0;try{const{data:t}=await V.get("/products/all",{params:{page:B.value,itemsPerPage:h.value,sortBy:((r=x.value[0])==null?void 0:r.key)||"createdAt",sortOrder:((a=x.value[0])==null?void 0:a.order)==="asc"?1:-1,search:P.value}});F.value.splice(0,F.value.length,...t.result.data),_.value=t.result.total}catch(t){console.log(t);const c=((e=(u=t==null?void 0:t.response)==null?void 0:u.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";p({text:c,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}A.value=!1};m();const M=()=>{B.value=1,m()};return(r,a)=>{const u=Q("VueFileAgent");return K(),W(Y,null,[l(be,null,{default:o(()=>[l(ye,null,{default:o(()=>[l($,{cols:"12"},{default:o(()=>[Pe]),_:1}),l(ke),l($,{cols:"12"},{default:o(()=>[l(v,{color:"green",onClick:a[0]||(a[0]=e=>q())},{default:o(()=>[S(" 新增商品 ")]),_:1})]),_:1}),l($,{cols:"12"},{default:o(()=>[l(Ce,{"items-per-page":h.value,"onUpdate:itemsPerPage":[a[2]||(a[2]=e=>h.value=e),m],"sort-by":x.value,"onUpdate:sortBy":[a[3]||(a[3]=e=>x.value=e),m],page:B.value,"onUpdate:page":[a[4]||(a[4]=e=>B.value=e),m],items:F.value,headers:j,loading:A.value,"items-length":_.value,search:P.value,hover:""},{top:o(()=>[l(D,{label:"搜尋","append-icon":"mdi-magnify",modelValue:P.value,"onUpdate:modelValue":a[1]||(a[1]=e=>P.value=e),"onClick:append":M,onKeydown:ee(M,["enter"])},null,8,["modelValue"])]),"item.image":o(({item:e})=>[l(ae,{src:e.image},null,8,["src"])]),"item.sell":o(({item:e})=>[e.sell?(K(),le(ce,{key:0,icon:"mdi-check"})):te("",!0)]),"item.edit":o(({item:e})=>[l(v,{icon:"mdi-pencil",variant:"text",color:"blue",onClick:t=>q(e)},null,8,["onClick"])]),"item.delete":o(({item:e})=>[l(v,{icon:"mdi-delete",variant:"text",color:"red",onClick:t=>z(e)},null,8,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1}),l(X,{modelValue:f.value,"onUpdate:modelValue":a[12]||(a[12]=e=>f.value=e),persistent:"",width:"500px"},{default:o(()=>[l(Ve,{disabled:s(U),onSubmit:oe(s(O),["prevent"])},{default:o(()=>[l(se,null,{default:o(()=>[l(re,null,{default:o(()=>[S(ne(i.value===""?"新增商品":"編輯商品"),1)]),_:1}),l(ue,null,{default:o(()=>[l(D,{label:"名稱",modelValue:s(b).value.value,"onUpdate:modelValue":a[5]||(a[5]=e=>s(b).value.value=e),"error-messages":s(b).errorMessage.value},null,8,["modelValue","error-messages"]),l(D,{label:"價格",type:"number",min:"0",modelValue:s(y).value.value,"onUpdate:modelValue":a[6]||(a[6]=e=>s(y).value.value=e),"error-messages":s(y).errorMessage.value},null,8,["modelValue","error-messages"]),l(we,{label:"分類",items:N,modelValue:s(C).value.value,"onUpdate:modelValue":a[7]||(a[7]=e=>s(C).value.value=e),"error-messages":s(C).errorMessage.value},null,8,["modelValue","error-messages"]),l(xe,{label:"上架",modelValue:s(w).value.value,"onUpdate:modelValue":a[8]||(a[8]=e=>s(w).value.value=e),"error-messages":s(w).errorMessage.value},null,8,["modelValue","error-messages"]),l(Be,{label:"說明",modelValue:s(k).value.value,"onUpdate:modelValue":a[9]||(a[9]=e=>s(k).value.value=e),"error-messages":s(k).errorMessage.value},null,8,["modelValue","error-messages"]),l(u,{modelValue:d.value,"onUpdate:modelValue":a[10]||(a[10]=e=>d.value=e),"raw-model-value":R.value,"onUpdate:rawModelValue":a[11]||(a[11]=e=>R.value=e),accept:"image/*",deletable:"","error-text":{type:"檔案格式不支援",size:"檔案超過 1MB 大小限制"},"help-text":"選擇檔案或拖曳到這裡","max-files":1,"max-size":"1MB",ref_key:"fileAgent",ref:T},null,8,["modelValue","raw-model-value"])]),_:1}),l(ie,null,{default:o(()=>[l(de),l(v,{color:"red",disabled:s(U),onClick:L},{default:o(()=>[S("取消")]),_:1},8,["disabled"]),l(v,{color:"green",type:"submit",loading:s(U)},{default:o(()=>[S("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};export{Re as default};
