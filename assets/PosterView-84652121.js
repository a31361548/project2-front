import{a9 as G,x as n,ak as Q,ab as W,al as X,c as t,ad as s,ap as Y,a0 as Z,ai as ee,ag as L,aJ as ae,V as te,ah as C,ao as R,J as h,ae as r,af as le,aq as oe,ar as se,aw as re,as as ne,av as ue}from"./index-2e906d0c.js";import{c as ie,a as M,e as de,V as ce}from"./index.esm-de8aadb6.js";import{u as me,a as A}from"./vee-validate.esm-018bef8b.js";import{V as pe}from"./VContainer-451776cb.js";import{V as ve}from"./VRow-ad76bf31.js";import{V as N}from"./VCol-dc2434c8.js";import{V as ge}from"./VDivider-bdd82a0d.js";import{V as fe}from"./VDataTableServer-947aec2b.js";import{V as be,a as Ve}from"./VTextarea-89071b05.js";import{a as ye}from"./VDataTable-8815a807.js";import"./VList-5a36ea62.js";import"./VMenu-d82125ac.js";const ke=ue("h1",{class:"text-center"},"文章管理",-1),Ie={__name:"PosterView",setup(we){const{apiAuth:v}=ee(),p=G(),T=n(null),g=n(!1),i=n(""),I=n(""),z=o=>{o?(i.value=o._id,I.value=o.userid.account,f.value.value=o.title,b.value.value=o.content,V.value.value=o.type,y.value.value=o.post):i.value="",g.value=!0},_=()=>{g.value=!1,E(),T.value.deleteFileRecord()},J=async o=>{var a,u;try{await v.delete("/articles/"+o._id),p({text:"刪除成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),c()}catch(e){console.log(e);const l=((u=(a=e==null?void 0:e.response)==null?void 0:a.data)==null?void 0:u.message)||"發生錯誤，請稍後再試";p({text:l,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},$=["經典調酒","超商酒單"],K=ie({title:M().required("標題為必填"),content:M().required("內文為必填"),type:M().required("分類為必填").test("isType","商品分類錯誤",o=>$.includes(o)),post:de()}),{handleSubmit:j,isSubmitting:B,resetForm:E}=me({validationSchema:K,initialValues:{title:"",content:"",type:"",post:!1}}),f=A("title"),b=A("content"),V=A("type"),y=A("post"),d=n([]),q=n([]),H=j(async o=>{var a,u,e;if(!((a=d.value[0])!=null&&a.error)&&!(i.value===""&&d.value.length===0))try{const l=new FormData;for(const m in o)l.append(m,o[m]);d.value.length>0&&l.append("image",d.value[0].file),i.value===""?(console.log("新增"),await v.post("/articles",l)):await v.patch("/articles/"+i.value,l),p({text:i.value===""?"新增成功":"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),_(),D()}catch(l){console.log(l);const m=((e=(u=l==null?void 0:l.response)==null?void 0:u.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";p({text:m,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),P=n(10),k=n([{key:"createdAt",order:"desc"}]),w=n(1),S=n([]),O=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"標題",align:"center",sortable:!0,key:"title"},{title:"分類",align:"center",sortable:!0,key:"type"},{title:"新增時間",align:"center",sortable:!0,key:"createdAt"},{title:"帳號",align:"center",key:"userid.account"},{title:"編輯",align:"center",sortable:!1,key:"edit"},{title:"刪除",align:"center",sortable:!1,key:"delete"}],F=n(!0),U=n(0),x=n(""),c=async()=>{var o,a,u,e;F.value=!0;try{const{data:l}=await v.get("/articles/all",{params:{page:w.value,itemsPerPage:P.value,sortBy:((o=k.value[0])==null?void 0:o.key)||"createdAt",sortOrder:((a=k.value[0])==null?void 0:a.order)==="asc"?1:-1,search:x.value}});S.value.splice(0,S.value.length,...l.result.data),U.value=l.result.total,console.log("嗨"),console.log(U),console.log(l.result.data)}catch(l){console.log(l);const m=((e=(u=l==null?void 0:l.response)==null?void 0:u.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";p({text:m,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}F.value=!1};c();const D=()=>{w.value=1,c()};return(o,a)=>{const u=Q("VueFileAgent");return W(),X(Z,null,[t(pe,null,{default:s(()=>[t(ve,null,{default:s(()=>[t(N,{cols:"12"},{default:s(()=>[ke]),_:1}),t(ge),t(N,{cols:"12"},{default:s(()=>[t(fe,{"items-per-page":P.value,"onUpdate:itemsPerPage":[a[1]||(a[1]=e=>P.value=e),c],"sort-by":k.value,"onUpdate:sortBy":[a[2]||(a[2]=e=>k.value=e),c],page:w.value,"onUpdate:page":[a[3]||(a[3]=e=>w.value=e),c],items:S.value,headers:O,loading:F.value,"items-length":U.value,search:x.value,hover:""},{top:s(()=>[t(L,{label:"搜尋","append-icon":"mdi-magnify",modelValue:x.value,"onUpdate:modelValue":a[0]||(a[0]=e=>x.value=e),"onClick:append":D,onKeydown:ae(D,["enter"])},null,8,["modelValue"])]),"item.image":s(({item:e})=>[t(te,{src:e.image},null,8,["src"])]),"item.createdAt":s(({item:e})=>[C(R(new Date(e.createdAt).toLocaleString()),1)]),"item.edit":s(({item:e})=>[t(h,{icon:"mdi-pencil",variant:"text",color:"blue",onClick:l=>z(e)},null,8,["onClick"])]),"item.delete":s(({item:e})=>[t(h,{icon:"mdi-delete",variant:"text",color:"red",onClick:l=>J(e)},null,8,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1}),t(Y,{modelValue:g.value,"onUpdate:modelValue":a[10]||(a[10]=e=>g.value=e),persistent:"",width:"500px"},{default:s(()=>[t(ce,{disabled:r(B),onSubmit:le(r(H),["prevent"])},{default:s(()=>[t(oe,null,{default:s(()=>[t(se,null,{default:s(()=>[t(re,null,{default:s(()=>[C(R(I.value),1)]),_:1}),t(L,{label:"標題",modelValue:r(f).value.value,"onUpdate:modelValue":a[4]||(a[4]=e=>r(f).value.value=e),"error-messages":r(f).errorMessage.value,disabled:"true"},null,8,["modelValue","error-messages"]),t(be,{label:"內文",modelValue:r(b).value.value,"onUpdate:modelValue":a[5]||(a[5]=e=>r(b).value.value=e),"error-messages":r(b).errorMessage.value,disabled:"true"},null,8,["modelValue","error-messages"]),t(ye,{label:"分類",items:$,modelValue:r(V).value.value,"onUpdate:modelValue":a[6]||(a[6]=e=>r(V).value.value=e),"error-messages":r(V).errorMessage.value,disabled:"true"},null,8,["modelValue","error-messages"]),t(Ve,{label:"貼文",modelValue:r(y).value.value,"onUpdate:modelValue":a[7]||(a[7]=e=>r(y).value.value=e),"error-messages":r(y).errorMessage.value},null,8,["modelValue","error-messages"]),t(u,{modelValue:d.value,"onUpdate:modelValue":a[8]||(a[8]=e=>d.value=e),"raw-model-value":q.value,"onUpdate:rawModelValue":a[9]||(a[9]=e=>q.value=e),accept:"image/jpg,image/png",deletable:"","error-text":{type:"檔案格式不支援",size:"檔案超過 1MB 大小限制"},"help-text":"選擇檔案或拖曳到這裡","max-files":1,"max-size":"1MB",ref_key:"fileAgent",ref:T,disabled:"true"},null,8,["modelValue","raw-model-value"])]),_:1}),t(ne,null,{default:s(()=>[t(h,{color:"blue",disabled:r(B),onClick:_},{default:s(()=>[C("取消")]),_:1},8,["disabled"]),t(h,{color:"green",type:"submit",loading:r(B)},{default:s(()=>[C("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};export{Ie as default};
